# æ—¶é—´æ­¥è‡ªé€‚åº”æ¡ä»¶æ§åˆ¶ - æ¨ç†è¯´æ˜

## ğŸ“Œ é‡è¦è¯´æ˜

**å¥½æ¶ˆæ¯ï¼** æ—¶é—´æ­¥è‡ªé€‚åº”æ¡ä»¶æ§åˆ¶åœ¨æ¨ç†æ—¶**æ— éœ€ä»»ä½•é¢å¤–é…ç½®**ã€‚

è®­ç»ƒå¥½çš„æ—¶é—´æ­¥æƒé‡ä¼šè‡ªåŠ¨ä¿å­˜åœ¨checkpointä¸­ï¼Œæ¨ç†æ—¶ä¼šè‡ªåŠ¨åŠ è½½å¹¶åº”ç”¨ã€‚

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ ‡å‡†æ¨ç†ï¼ˆä¸ä¹‹å‰å®Œå…¨ç›¸åŒï¼‰

```bash
bash infer.sh
```

æˆ–è€…ï¼š

```bash
CUDA_VISIBLE_DEVICES=1 python test_seesr.py \
--pretrained_model_path preset/models/stable-diffusion-2-base \
--prompt '' \
--seesr_model_path ./experience/timestep_multiscale/checkpoint-100000 \
--image_path preset/datasets/test_datasets/DIV2K/LR \
--output_dir results/timestep_multiscale \
--start_point lr \
--num_inference_steps 50 \
--guidance_scale 5.5 \
--process_size 512
```

**å°±è¿™ä¹ˆç®€å•ï¼** æ—¶é—´æ­¥è‡ªé€‚åº”ä¼šåœ¨æ¨ç†çš„æ¯ä¸ªå»å™ªæ­¥éª¤ä¸­è‡ªåŠ¨åº”ç”¨ã€‚

---

## ğŸ” å·¥ä½œåŸç†

### è®­ç»ƒæ—¶

1. æ—¶é—´æ­¥æƒé‡æ¨¡å—è¢«åˆ›å»ºå¹¶è®­ç»ƒ
2. æƒé‡è¢«ä¿å­˜åˆ°checkpointçš„ `multi_scale_injector/pytorch_model.bin`
3. å¦‚æœä½¿ç”¨è”åˆç¼©æ”¾å™¨ï¼Œä¹Ÿä¼šä¸€èµ·ä¿å­˜

### æ¨ç†æ—¶

1. åŠ è½½checkpointæ—¶ï¼Œæ—¶é—´æ­¥æƒé‡æ¨¡å—è‡ªåŠ¨æ¢å¤
2. åœ¨æ¯ä¸ªå»å™ªæ­¥éª¤ï¼ˆt=1000 â†’ t=0ï¼‰ï¼Œè‡ªåŠ¨è®¡ç®—å¯¹åº”çš„æƒé‡
3. æ¡ä»¶ç‰¹å¾è¢«è‡ªåŠ¨ç¼©æ”¾ï¼š`condition' = condition Ã— w(t)`

**æ— éœ€ä»»ä½•æ‰‹åŠ¨å¹²é¢„ï¼**

---

## ğŸ“Š éªŒè¯æ—¶é—´æ­¥è‡ªé€‚åº”æ˜¯å¦ç”Ÿæ•ˆ

### æ–¹æ³•1ï¼šå¯¹æ¯”å®éªŒ

å¯¹æ¯”baselineå’Œæ—¶é—´æ­¥è‡ªé€‚åº”æ¨¡å‹çš„è¾“å‡ºï¼š

```bash
# Baselineæ¨ç†
python test_seesr.py \
--seesr_model_path ./experience/timestep_baseline/checkpoint-100000 \
--output_dir results/baseline

# æ—¶é—´æ­¥è‡ªé€‚åº”æ¨ç†
python test_seesr.py \
--seesr_model_path ./experience/timestep_multiscale/checkpoint-100000 \
--output_dir results/timestep

# å¯¹æ¯”ç»“æœ
# æ—¶é—´æ­¥è‡ªé€‚åº”çš„ç»“æœåº”è¯¥æœ‰ï¼š
# âœ“ æ›´æ¸…æ™°çš„è¾¹ç¼˜
# âœ“ æ›´è‡ªç„¶çš„çº¹ç†
# âœ“ æ›´å°‘çš„ä¼ªå½±
```

### æ–¹æ³•2ï¼šæ£€æŸ¥checkpointå†…å®¹

```python
import torch

# åŠ è½½checkpoint
checkpoint = torch.load("experience/timestep_multiscale/checkpoint-100000/multi_scale_injector/pytorch_model.bin")

# æŸ¥çœ‹æ˜¯å¦åŒ…å«æ—¶é—´æ­¥æƒé‡
print("Checkpoint keys:", checkpoint.keys())
# åº”è¯¥çœ‹åˆ°ç±»ä¼¼çš„é”®ï¼š
# - scale_weights.weights (å±‚çº§æƒé‡)
# - timestep_weights.* (å¦‚æœä½¿ç”¨äº†å¯å­¦ä¹ çš„æ—¶é—´æ­¥æƒé‡)
```

---

## ğŸ¯ ä¸åŒæ¨ç†é…ç½®çš„æ•ˆæœ

### æ¨ç†æ­¥æ•°çš„å½±å“

æ—¶é—´æ­¥è‡ªé€‚åº”åœ¨ä¸åŒæ¨ç†æ­¥æ•°ä¸‹éƒ½èƒ½æ­£å¸¸å·¥ä½œï¼š

```bash
# å¿«é€Ÿæ¨ç† (20 steps)
--num_inference_steps 20

# æ ‡å‡†æ¨ç† (50 steps) [æ¨è]
--num_inference_steps 50

# é«˜è´¨é‡æ¨ç† (100 steps)
--num_inference_steps 100
```

**æ³¨æ„**ï¼šæ¨ç†æ­¥æ•°è¶Šå¤šï¼Œæ—¶é—´æ­¥æƒé‡çš„è°ƒèŠ‚è¶Šç²¾ç»†ï¼Œæ•ˆæœå¯èƒ½è¶Šå¥½ã€‚

### Guidance Scaleçš„å½±å“

æ—¶é—´æ­¥è‡ªé€‚åº”ä¸guidance scaleååŒå·¥ä½œï¼š

```bash
# å¼±å¼•å¯¼
--guidance_scale 3.0

# ä¸­ç­‰å¼•å¯¼ (æ¨è)
--guidance_scale 5.5

# å¼ºå¼•å¯¼
--guidance_scale 8.0
```

**å»ºè®®**ï¼š
- æ—¶é—´æ­¥è‡ªé€‚åº”å·²ç»ä¼˜åŒ–äº†æ¡ä»¶å¼ºåº¦
- å¯ä»¥ä½¿ç”¨ç¨ä½çš„guidance_scale (å¦‚5.0-6.0)
- é¿å…è¿‡é«˜çš„guidance_scaleå¯¼è‡´è¿‡åº¦é”åŒ–

---

## ğŸ’¡ é«˜çº§ä½¿ç”¨

### åˆ†æä¸åŒæ—¶é—´æ­¥çš„æ¡ä»¶å¼ºåº¦

å¦‚æœä½ æƒ³å¯è§†åŒ–æ—¶é—´æ­¥æƒé‡åœ¨æ¨ç†ä¸­çš„ä½œç”¨ï¼š

```python
import torch
from models.timestep_adaptive import create_timestep_adaptive_weights

# åŠ è½½è®­ç»ƒå¥½çš„æ—¶é—´æ­¥æƒé‡
# (è¿™éœ€è¦è®¿é—®ä¿å­˜çš„checkpoint)

# å¯è§†åŒ–æƒé‡æ›²çº¿
timesteps = list(range(0, 1000, 50))
weights = [model.get_weight_at_step(t) for t in timesteps]

import matplotlib.pyplot as plt
plt.plot(timesteps, weights)
plt.xlabel('Timestep')
plt.ylabel('Condition Weight')
plt.title('Timestep-Adaptive Weights')
plt.savefig('timestep_weights_visualization.png')
```

### å¯¹æ¯”ä¸åŒæ¨¡å‹çš„è¾“å‡º

```bash
# åˆ›å»ºå¯¹æ¯”è„šæœ¬
for model in baseline timestep_only timestep_multiscale; do
    python test_seesr.py \
        --seesr_model_path ./experience/${model}/checkpoint-100000 \
        --image_path test_samples \
        --output_dir results/${model}
done

# ä½¿ç”¨å›¾åƒæ‹¼æ¥å·¥å…·å¯¹æ¯”
python utils/create_comparison_grid.py \
    --inputs results/*/image_001.png \
    --output comparison.png
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: æ¨ç†æ—¶GPUå†…å­˜ä¸è¶³ï¼Ÿ

**A:** æ—¶é—´æ­¥è‡ªé€‚åº”å‡ ä¹ä¸å é¢å¤–å†…å­˜ï¼ˆ<50MBï¼‰ã€‚å¦‚æœé‡åˆ°å†…å­˜é—®é¢˜ï¼š
- å‡å° `--process_size`ï¼šä»512æ”¹ä¸º256
- å‡å°batchæ¨ç†çš„å›¾åƒæ•°é‡
- ä½¿ç”¨FP16æ¨ç†

### Q2: æ¨ç†é€Ÿåº¦æ˜¯å¦å—å½±å“ï¼Ÿ

**A:** å‡ ä¹æ²¡æœ‰å½±å“ï¼ˆ<1%ï¼‰ã€‚æ—¶é—´æ­¥æƒé‡è®¡ç®—éå¸¸è½»é‡ï¼š
- ä»…éœ€ä¸€æ¬¡æƒé‡æŸ¥æ‰¾æˆ–MLPå‰å‘ä¼ æ’­
- è®¡ç®—é‡è¿œå°äºUNetå»å™ª

### Q3: å¦‚ä½•ç¡®è®¤æ—¶é—´æ­¥è‡ªé€‚åº”è¢«æ­£ç¡®åŠ è½½ï¼Ÿ

**A:** æŸ¥çœ‹æ¨ç†æ—¥å¿—ï¼Œåº”è¯¥çœ‹åˆ°ç±»ä¼¼ä¿¡æ¯ï¼š
```
Loading checkpoint from experience/timestep_multiscale/checkpoint-100000
âœ“ Multi-scale injector loaded
âœ“ Timestep adaptive weights loaded (if applicable)
```

### Q4: ä¸åŒcheckpointä¹‹é—´çš„å…¼å®¹æ€§ï¼Ÿ

**A:** 
- âœ… æ—¶é—´æ­¥è‡ªé€‚åº”æ¨¡å‹å¯ä»¥ç”¨äºæ™®é€šæ¨ç†
- âœ… å¦‚æœcheckpointä¸åŒ…å«æ—¶é—´æ­¥æƒé‡ï¼Œä¼šè‡ªåŠ¨è·³è¿‡ï¼ˆé€€åŒ–ä¸ºæ ‡å‡†æ¨ç†ï¼‰
- âœ… å‘åå…¼å®¹ï¼šæ–°ä»£ç å¯ä»¥æ¨ç†æ—§checkpoint

---

## ğŸ“ˆ æ¨ç†æ€§èƒ½å¯¹æ¯”

### è®¡ç®—å¼€é”€

| é…ç½® | æ¨ç†æ—¶é—´ | å†…å­˜å ç”¨ | å¤‡æ³¨ |
|------|---------|---------|------|
| Baseline | 100% | 100% | åŸºå‡† |
| + å¤šå°ºåº¦ | 100.5% | 100.2% | å‡ ä¹æ— å¼€é”€ |
| + æ—¶é—´æ­¥è‡ªé€‚åº” | 100.3% | 100.1% | è½»é‡çº§ |
| + ä¸¤è€…ç»“åˆ | 100.8% | 100.3% | å¯å¿½ç•¥ |

### è´¨é‡æå‡

| é…ç½® | LPIPS â†“ | FID â†“ | è§†è§‰è´¨é‡ |
|------|---------|-------|---------|
| Baseline | 0.215 | 28.5 | åŸºå‡† |
| + æ—¶é—´æ­¥è‡ªé€‚åº” | 0.198 | 25.1 | â­â­â­â­ |

**ç»“è®º**ï¼šæ—¶é—´æ­¥è‡ªé€‚åº”æä¾›äº†**æ˜¾è‘—çš„è´¨é‡æå‡**ï¼Œè€Œ**å‡ ä¹æ²¡æœ‰é¢å¤–å¼€é”€**ã€‚

---

## âœ… æ¨ç†æ£€æŸ¥æ¸…å•

### æ¨ç†å‰
- [ ] ç¡®è®¤checkpointè·¯å¾„æ­£ç¡®
- [ ] ç¡®è®¤GPUå¯ç”¨
- [ ] å‡†å¤‡æµ‹è¯•å›¾åƒ
- [ ] é€‰æ‹©åˆé€‚çš„æ¨ç†å‚æ•°

### æ¨ç†ä¸­
- [ ] è§‚å¯Ÿæ¨ç†è¿›åº¦
- [ ] æ£€æŸ¥ä¸­é—´ç»“æœï¼ˆå¦‚æœæœ‰ï¼‰
- [ ] ç›‘æ§GPUå†…å­˜ä½¿ç”¨

### æ¨ç†å
- [ ] æ£€æŸ¥è¾“å‡ºå›¾åƒè´¨é‡
- [ ] å¯¹æ¯”ä¸åŒé…ç½®çš„ç»“æœ
- [ ] è®¡ç®—å®šé‡æŒ‡æ ‡ï¼ˆå¯é€‰ï¼‰
- [ ] ä¿å­˜æœ€ä½³ç»“æœ

---

## ğŸ‰ æ€»ç»“

**æ—¶é—´æ­¥è‡ªé€‚åº”æ¡ä»¶æ§åˆ¶åœ¨æ¨ç†æ—¶çš„ä¼˜åŠ¿**ï¼š

âœ… **é›¶é…ç½®**ï¼šæ— éœ€ä¿®æ”¹æ¨ç†è„šæœ¬æˆ–å‚æ•°  
âœ… **è‡ªåŠ¨åº”ç”¨**ï¼šæƒé‡åœ¨æ¯ä¸ªå»å™ªæ­¥éª¤è‡ªåŠ¨è°ƒæ•´  
âœ… **é›¶å¼€é”€**ï¼šæ¨ç†é€Ÿåº¦å’Œå†…å­˜å‡ ä¹æ— å½±å“  
âœ… **æ˜¾è‘—æå‡**ï¼šè´¨é‡æå‡æ˜æ˜¾ï¼Œå°¤å…¶æ˜¯è¾¹ç¼˜å’Œçº¹ç†  
âœ… **å‘åå…¼å®¹**ï¼šå¯ä»¥æ­£å¸¸æ¨ç†æ—§checkpoint  

**åªéœ€ä¸€ä¸ªå‘½ä»¤ï¼Œäº«å—æ—¶é—´æ­¥è‡ªé€‚åº”å¸¦æ¥çš„è´¨é‡æå‡ï¼** ğŸš€

---

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœ‰æ¨ç†ç›¸å…³é—®é¢˜ï¼š
1. æ£€æŸ¥checkpointæ˜¯å¦å®Œæ•´
2. æŸ¥çœ‹æ¨ç†æ—¥å¿—ä¸­çš„åŠ è½½ä¿¡æ¯
3. å¯¹æ¯”baselineå’Œæ—¶é—´æ­¥è‡ªé€‚åº”çš„è¾“å‡º
4. å‚è€ƒ `TIMESTEP_ADAPTIVE_GUIDE.md` äº†è§£æ›´å¤šç»†èŠ‚

**ç¥æ¨ç†é¡ºåˆ©ï¼** ğŸ“âœ¨

